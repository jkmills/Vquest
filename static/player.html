<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Player View</title>
  <link rel="stylesheet" href="medieval.css">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const codeParam = params.get('code') || '';
  </script>
</head>
<body>
  <div id="root" style="max-width: 500px; margin: 2em auto; background: #fffbe6cc; border-radius: 16px; box-shadow: 2px 2px 12px #0003; padding: 2em;"></div>
  <script>
    function App() {
      const [name, setName] = React.useState('');
      const [race, setRace] = React.useState('Human');
      const [imageFile, setImageFile] = React.useState(null);
      const [isLoading, setIsLoading] = React.useState(false);
      const [code, setCode] = React.useState(codeParam);
      const [player, setPlayer] = React.useState(null);
      const [context, setContext] = React.useState([]);
      const [prompt, setPrompt] = React.useState('');
      const [actions, setActions] = React.useState([]);
      const [votes, setVotes] = React.useState([]);
      const [hasVoted, setHasVoted] = React.useState(false);
      const [phase, setPhase] = React.useState('SUBMITTING');
      const [submissionStatus, setSubmissionStatus] = React.useState('');
      const [winningAction, setWinningAction] = React.useState(null);
      const wsRef = React.useRef(null);

      const join = async () => {
        setIsLoading(true);
        const formData = new FormData();
        formData.append('name', name);
        formData.append('race', race);
        if (imageFile) {
          formData.append('image', imageFile);
        }

        try {
          const res = await fetch(`/room/${code}/join`, {
            method: 'POST',
            body: formData,
          });
          const data = await res.json();
          if (data.id) {
            setPlayer(data);
            setContext(data.context);
            setPrompt(data.prompt);
            setPhase(data.phase);
          } else {
            console.error('Failed to join room:', data);
          }
        } catch (error) {
          console.error('Error joining room:', error);
        } finally {
          setIsLoading(false);
        }
      };

      React.useEffect(() => {
        if (!player) return;
        const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsProto}://${location.host}/room/${code}`);
        ws.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            if (data.context) setContext(data.context);
            if (data.prompt) setPrompt(data.prompt);
            if (data.phase) setPhase(data.phase);
            if (data.winningAction) setWinningAction(data.winningAction);

            if (data.phase === 'SUBMITTING') {
              // Reset for new round
              setHasVoted(false);
              setWinningAction(null);
              setVotes([]);
              setActions([]);
              setSubmissionStatus('');
            }

            if (data.submitted_count !== undefined) {
                setSubmissionStatus(`(${data.submitted_count}/${data.players_count} submitted)`);
            }

            if (data.actions) {
              setActions(data.actions);
            }
            if (data.votes) setVotes(data.votes);
          } catch (error) {
            console.error('Error parsing WebSocket message:', error);
          }
        };
        wsRef.current = ws;
        return () => ws.close();
      }, [player]);

      const sendAction = async () => {
        if (!player) return;
        const text = document.getElementById('actionText').value;
        await fetch(`/room/${code}/action`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({player_id: player.id, text})
        });
      };

      const vote = async (choice) => {
        if (!player) return;
        await fetch(`/room/${code}/vote`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({player_id: player.id, choice})
        });
        setHasVoted(true);
      };

      return React.createElement('div', null,
        React.createElement('h1', null, 'Player'),
        !player
          ? React.createElement('div', null,
              React.createElement('h2', null, 'Create Your Character'),
              React.createElement('div', null,
                'Name ', React.createElement('input', {value: name, onChange: e => setName(e.target.value)})),
              React.createElement('div', null,
                'Race ',
                React.createElement('select', {value: race, onChange: e => setRace(e.target.value)},
                  React.createElement('option', {value: 'Human'}, 'Human'),
                  React.createElement('option', {value: 'Elf'}, 'Elf'),
                  React.createElement('option', {value: 'Dwarf'}, 'Dwarf'),
                  React.createElement('option', {value: 'Orc'}, 'Orc'),
                  React.createElement('option', {value: 'Halfling'}, 'Halfling')
                )
              ),
              React.createElement('div', null,
                'Appearance (optional) ', React.createElement('input', {type: 'file', onChange: e => setImageFile(e.target.files[0])})
              ),
              React.createElement('div', null,
                'Room Code ', React.createElement('input', {value: code, onChange: e => setCode(e.target.value)})),
              React.createElement('button', {onClick: join, disabled: isLoading}, isLoading ? 'Creating...' : 'Create Character')
            )
          : React.createElement('div', null,
              React.createElement('h2', null, player.name),
              player.character && React.createElement('div', null,
                player.character.imageUrl && React.createElement('img', {src: player.character.imageUrl, style: {maxWidth: '100%', borderRadius: '8px'}}),
                React.createElement('h3', null, 'Stats'),
                player.character.stats && React.createElement('ul', null,
                  Object.entries(player.character.stats).map(([stat, value]) =>
                    React.createElement('li', {key: stat}, `${stat}: ${value}`)
                  )
                ),
                React.createElement('h3', null, 'Inventory'),
                player.character.inventory && React.createElement('ul', null,
                  player.character.inventory.length > 0
                    ? player.character.inventory.map((item, i) =>
                        React.createElement('li', {key: i}, item)
                      )
                    : React.createElement('li', null, 'Empty')
                )
              ),
              React.createElement('hr', null),
              React.createElement('div', { className: 'chat-container' },
                context.map((msg, i) =>
                  React.createElement('div', { key: i, className: `chat-bubble ${msg.sender === 'DM' ? 'dm-message' : ''} ${msg.sender === 'Game' ? 'game-message' : ''}` },
                    React.createElement('div', { className: 'sender' }, msg.sender),
                    React.createElement('div', null, msg.text)
                  )
                )
              ),
              React.createElement('div', {style: {marginBottom: '1em', fontWeight: 'bold'}}, prompt),

              phase === 'SUBMITTING' && React.createElement('div', null,
                React.createElement('h2', null, `Submit your action ${submissionStatus}`),
                React.createElement('input', {id: 'actionText', placeholder: 'Your action'}),
                React.createElement('button', {onClick: sendAction}, 'Send')
              ),

              phase === 'VOTING' && React.createElement('div', null,
                React.createElement('h2', null, 'Vote for the best action'),
                actions.map((action, i) =>
                  React.createElement('div', {key: i, style: {marginBottom: '0.5em'}},
                    React.createElement('button', {onClick: () => vote(i), disabled: hasVoted}, 'Vote'),
                    ` ${action.text} (${votes[i] || 0} votes)`
                  )
                )
              ),

              phase === 'POST_VOTE' && React.createElement('div', null,
                React.createElement('h2', null, 'Voting Complete!'),
                winningAction && React.createElement('p', {style: {fontWeight: 'bold'}}, `Winning action: ${winningAction.text}`),
                React.createElement('h3', null, 'Final Results:'),
                actions.map((action, i) =>
                  React.createElement('div', {key: i, style: {marginBottom: '0.5em'}},
                    `${action.text} (${votes[i] || 0} votes)`
                  )
                )
              )
            )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
