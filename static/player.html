<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Player View</title>
  <link rel="stylesheet" href="medieval.css">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const codeParam = params.get('code') || '';
  </script>
</head>
<body>
  <div id="root" style="max-width: 500px; margin: 0 auto; background: #fffbe6cc; height: 100vh; display: flex; flex-direction: column;"></div>
  <script>
    function App() {
      const [name, setName] = React.useState('');
      const [race, setRace] = React.useState('Human');
      const [imageFile, setImageFile] = React.useState(null);
      const [isLoading, setIsLoading] = React.useState(false);
      const [code, setCode] = React.useState(codeParam);
      const [player, setPlayer] = React.useState(null);
      const [context, setContext] = React.useState([]);
      const [prompt, setPrompt] = React.useState('');
      const [actions, setActions] = React.useState([]);
      const [votes, setVotes] = React.useState([]);
      const [hasVoted, setHasVoted] = React.useState(false);
      const [phase, setPhase] = React.useState('SUBMITTING');
      const [submissionStatus, setSubmissionStatus] = React.useState('');
      const [winningAction, setWinningAction] = React.useState(null);
      const [regenerationCount, setRegenerationCount] = React.useState(0);
      const [isRegenerating, setIsRegenerating] = React.useState(false);
      const wsRef = React.useRef(null);
      const chatContainerRef = React.useRef(null);

      React.useEffect(() => {
        if (chatContainerRef.current) {
          chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
        }
      }, [context]);

      const join = async () => {
        setIsLoading(true);
        const formData = new FormData();
        formData.append('name', name);
        formData.append('race', race);
        if (imageFile) {
          formData.append('image', imageFile);
        }

        try {
          const res = await fetch(`/room/${code}/join`, {
            method: 'POST',
            body: formData,
          });
          const data = await res.json();
          if (data.id) {
            setPlayer(data);
            setContext(data.context);
            setPrompt(data.prompt);
            setPhase(data.phase);
            setRegenerationCount(data.regenerationAttempts || 0);
          } else {
            console.error('Failed to join room:', data);
          }
        } catch (error) {
          console.error('Error joining room:', error);
        } finally {
          setIsLoading(false);
        }
      };

      const regenerateImage = async () => {
        if (!player || isRegenerating) return;
        setIsRegenerating(true);

        const formData = new FormData();
        if (imageFile) {
            formData.append('image', imageFile);
        }

        try {
          const res = await fetch(`/room/${code}/player/${player.id}/regenerate-image`, {
            method: 'POST',
            body: formData,
          });
          const data = await res.json();
          if (data.id) {
            setPlayer(data);
            setRegenerationCount(data.regenerationAttempts);
          } else {
            console.error('Failed to regenerate image:', data);
          }
        } catch (error) {
          console.error('Error regenerating image:', error);
        } finally {
          setIsRegenerating(false);
        }
      };

      React.useEffect(() => {
        if (!player) return;
        const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsProto}://${location.host}/room/${code}`);
        ws.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            if (data.context) setContext(data.context);
            if (data.prompt) setPrompt(data.prompt);
            if (data.phase) setPhase(data.phase);
            if (data.winningAction) setWinningAction(data.winningAction);

            if (data.phase === 'SUBMITTING') {
              // Reset for new round
              setHasVoted(false);
              setWinningAction(null);
              setVotes([]);
              setActions([]);
              setSubmissionStatus('');
            }

            if (data.submitted_count !== undefined) {
                setSubmissionStatus(`(${data.submitted_count}/${data.players_count} submitted)`);
            }

            if (data.actions) {
              setActions(data.actions);
            }
            if (data.votes) setVotes(data.votes);
            if (data.players && player && data.players[player.id]) {
                const updatedPlayer = data.players[player.id];
                if (updatedPlayer.character.imageUrl !== player.character.imageUrl || updatedPlayer.regenerationAttempts !== player.regenerationAttempts) {
                    setPlayer(prevPlayer => ({...prevPlayer, ...updatedPlayer}));
                }
            }
          } catch (error) {
            console.error('Error parsing WebSocket message:', error);
          }
        };
        wsRef.current = ws;
        return () => ws.close();
      }, [player]);

      const sendAction = async () => {
        if (!player) return;
        const textEl = document.getElementById('actionText');
        const text = textEl.value;
        if (!text) return;
        await fetch(`/room/${code}/action`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({player_id: player.id, text})
        });
        textEl.value = ''; // Clear input after sending
      };

      const vote = async (choice) => {
        if (!player) return;
        await fetch(`/room/${code}/vote`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({player_id: player.id, choice})
        });
        setHasVoted(true);
      };

      // Define styles outside of render for performance and readability
      const styles = {
        playerContainer: {
          display: 'flex',
          flexDirection: 'column',
          height: '100%',
          padding: '1em'
        },
        characterInfo: {
          flexShrink: 0
        },
        chatContainer: {
          flexGrow: 1,
          overflowY: 'auto',
          border: '1px solid #ccc',
          borderRadius: '8px',
          padding: '0.5em',
          marginBottom: '1em',
          background: '#fff'
        },
        prompt: {
          marginBottom: '1em',
          fontWeight: 'bold',
          flexShrink: 0
        },
        actionBar: {
          flexShrink: 0
        },
        actionInput: {
          width: 'calc(100% - 80px)',
          padding: '0.5em',
          marginRight: '1em'
        },
        voteButton: {
            marginRight: '1em',
            padding: '0.5em 1em'
        }
      };

      return React.createElement('div', { style: { height: '100vh', display: 'flex', flexDirection: 'column', padding: '1em', boxSizing: 'border-box' } },
        React.createElement('h1', { style: { textAlign: 'center', flexShrink: 0 } }, 'Player'),
        !player
          ? React.createElement('div', { style: { padding: '2em' } },
              React.createElement('h2', null, 'Create Your Character'),
              React.createElement('div', { style: { marginBottom: '0.5em' } },
                'Name ', React.createElement('input', {value: name, onChange: e => setName(e.target.value)})),
              React.createElement('div', { style: { marginBottom: '0.5em' } },
                'Race ',
                React.createElement('select', {value: race, onChange: e => setRace(e.target.value)},
                  React.createElement('option', {value: 'Human'}, 'Human'),
                  React.createElement('option', {value: 'Elf'}, 'Elf'),
                  React.createElement('option', {value: 'Dwarf'}, 'Dwarf'),
                  React.createElement('option', {value: 'Orc'}, 'Orc'),
                  React.createElement('option', {value: 'Halfling'}, 'Halfling')
                )
              ),
              React.createElement('div', { style: { marginBottom: '0.5em' } },
                'Appearance (optional) ', React.createElement('input', {type: 'file', onChange: e => setImageFile(e.target.files[0])})
              ),
              React.createElement('div', { style: { marginBottom: '1em' } },
                'Room Code ', React.createElement('input', {value: code, onChange: e => setCode(e.target.value)})),
              React.createElement('button', {onClick: join, disabled: isLoading}, isLoading ? 'Creating...' : 'Create Character')
            )
          : React.createElement('div', { style: styles.playerContainer },
              React.createElement('details', { style: styles.characterInfo },
                React.createElement('summary', null, React.createElement('h2', { style: { display: 'inline-block', margin: 0 } }, player.name)),
                player.character && React.createElement('div', null,
                  player.character.imageUrl && React.createElement('div', null,
                    React.createElement('img', {src: player.character.imageUrl, style: {maxWidth: '100px', borderRadius: '8px'}}),
                    React.createElement('button', {onClick: regenerateImage, disabled: isRegenerating || regenerationCount >= 3, style: {marginLeft: '1em'}},
                      isRegenerating ? 'Regenerating...' : `Regenerate Image (${regenerationCount}/3)`
                    )
                  ),
                  React.createElement('h3', null, 'Stats'),
                  player.character.stats && React.createElement('ul', null,
                    Object.entries(player.character.stats).map(([stat, value]) =>
                      React.createElement('li', {key: stat}, `${stat}: ${value}`)
                    )
                  ),
                  React.createElement('h3', null, 'Inventory'),
                  player.character.inventory && React.createElement('ul', null,
                    player.character.inventory.length > 0
                      ? player.character.inventory.map((item, i) =>
                          React.createElement('li', {key: i}, item)
                        )
                      : React.createElement('li', null, 'Empty')
                  )
                )
              ),
              React.createElement('hr', { style: { flexShrink: 0 } }),
              React.createElement('div', { ref: chatContainerRef, style: styles.chatContainer, className: 'chat-container' },
                context.map((msg, i) =>
                  React.createElement('div', { key: i, className: `chat-bubble ${msg.sender === 'DM' ? 'dm-message' : ''} ${msg.sender === 'Game' ? 'game-message' : ''}` },
                    React.createElement('div', { className: 'sender' }, msg.sender),
                    React.createElement('div', null, msg.text)
                  )
                )
              ),
              React.createElement('div', { style: styles.prompt }, prompt),

              phase === 'SUBMITTING' && React.createElement('div', { style: styles.actionBar },
                React.createElement('h3', { style: { marginTop: 0 } }, `Submit your action ${submissionStatus}`),
                React.createElement('input', {id: 'actionText', placeholder: 'Your action', style: styles.actionInput }),
                React.createElement('button', {onClick: sendAction}, 'Send')
              ),

              phase === 'VOTING' && React.createElement('div', { style: styles.actionBar },
                React.createElement('h3', { style: { marginTop: 0 } }, 'Vote for the best action'),
                actions.map((action, i) =>
                  React.createElement('div', {key: i, style: {marginBottom: '0.5em'}},
                    React.createElement('button', {onClick: () => vote(i), disabled: hasVoted, style: styles.voteButton }, 'Vote'),
                    ` ${action.text} (${votes[i] || 0} votes)`
                  )
                )
              ),

              phase === 'POST_VOTE' && React.createElement('div', { style: styles.actionBar },
                React.createElement('h2', null, 'Voting Complete!'),
                winningAction && React.createElement('p', {style: {fontWeight: 'bold'}}, `Winning action: ${winningAction.text}`),
                React.createElement('h3', null, 'Final Results:'),
                actions.map((action, i) =>
                  React.createElement('div', {key: i, style: {marginBottom: '0.5em'}},
                    `${action.text} (${votes[i] || 0} votes)`
                  )
                )
              )
            )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
